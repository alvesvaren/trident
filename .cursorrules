# Arrow Type Implementation Guide

When adding a new arrow type to Trident, the following files need to be updated:

## 1. Rust Parser (`trident-core/src/parser/types.rs`)

Add the arrow token and canonical name to `ARROW_REGISTRY`:
- **Location**: `ARROW_REGISTRY` constant array
- **Format**: `("token_string", "canonical_name")`
- **Important**: Longer tokens must come first to avoid partial matches
- **Canonical naming convention**:
  - Use `_right` suffix for arrows pointing right (e.g., `A --> B`)
  - Use `_left` suffix for arrows pointing left (e.g., `A <-- B`)
  - Use descriptive prefixes: `extends_`, `dep_`, `assoc_`, `aggregate`, `compose`

Example:
```rust
pub const ARROW_REGISTRY: &[(&str, &str)] = &[
    ("<|..", "dep_extends_left"),
    ("..|>", "dep_extends_right"),
    // ... other arrows
];
```

## 2. TypeScript Syntax Highlighting (`src/syntax.ts`)

Update three locations:

### a) ARROWS array (for autocomplete)
Add to the `ARROWS` constant array with label and detail:
```typescript
const ARROWS = [
  { token: "..|>", label: "..|> (dotted extends)", detail: "Dotted inheritance arrow" },
  // ... other arrows
];
```

### b) Monarch tokenizer arrows array
Add to the `arrows` array in the tokenizer configuration (longest first):
```typescript
arrows: ["<|..", "..|>", "<|--", "--|>", /* ... */],
```

### c) Tokenizer regex pattern
Add the token pattern to the operator regex:
```typescript
[/<\|\.\.|\.\.\|>|<\|--|--\|>|\.\.>|<\.\.|----|-->|<--|o--|\*--|\.\./, "operator"],
```

## 3. TypeScript Rendering (`src/utils/geometry.ts`)

### a) `isDashed()` function
Determine if the arrow should render as a dashed line:
- Check if arrow name starts with `dep_` (already handled by current implementation)
- Or add explicit check: `arrow === "dotted" || arrow.startsWith("dep_")`

### b) `getEdgeMarkers()` function
Determine which SVG markers to use:
- Check the base arrow name (without `_left`/`_right` suffix)
- Add cases for triangle markers (`extends` style), arrowhead markers (`assoc`/`dep` style), or diamond markers (`aggregate`/`compose` style)
- Example: `if (baseArrow === "extends" || baseArrow === "dep_extends")`

## 4. Layout Logic (`trident-core/src/layout/placement.rs`)

Update `get_edge_direction()` function if the arrow affects hierarchical layout:
- Add the new arrow canonical names to the appropriate match arm
- Determine parent-child relationship for hierarchical layout
- Example: `"extends_right" | "dep_extends_right" => (to, from)`

## 5. SVG Markers (`src/components/diagram/SVGEdges.tsx`)

If a new marker type is needed (not just reusing existing ones):
- Add new `<marker>` definitions in `EdgeDefs()` function
- Use appropriate IDs like `triangle-end`, `triangle-start`, `arrowhead-end`, `arrowhead-start`, `diamond-start`, `diamond-empty-start`

## Testing Checklist

After adding a new arrow type:
- [ ] Parser recognizes the token in compact form (e.g., `A..|>B`)
- [ ] Parser recognizes the token with spaces (e.g., `A ..|> B`)
- [ ] Monaco editor syntax highlights the arrow correctly
- [ ] Monaco editor autocomplete suggests the arrow
- [ ] Arrow renders correctly in the diagram (dashed/solid, correct markers)
- [ ] Layout algorithm handles the arrow correctly (if hierarchical)
- [ ] Code generation preserves the arrow token correctly
